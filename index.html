<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ”¯é»æ•™è‚² - æ•¸å­¸ç´ é¤ŠæŒ‘æˆ°</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #fff;
            overflow-x: hidden;
        }
        
        /* é ‚éƒ¨ç‹€æ…‹åˆ— */
        .status-bar {
            background: rgba(0,0,0,0.5);
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
        }
        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 16px;
        }
        .status-item .value {
            color: #ffd700;
            font-weight: bold;
            font-size: 20px;
        }
        .streak-fire { color: #ff6b35; }
        
        /* ç™»å…¥ç•«é¢ */
        .login-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        .login-screen.hidden { display: none; }
        .login-box {
            background: rgba(255,255,255,0.95);
            border-radius: 20px;
            padding: 30px;
            width: 90%;
            max-width: 400px;
            color: #333;
        }
        .login-title {
            text-align: center;
            font-size: 28px;
            margin-bottom: 20px;
            color: #667eea;
        }
        .login-tabs {
            display: flex;
            margin-bottom: 20px;
        }
        .login-tab {
            flex: 1;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            border-bottom: 3px solid #ddd;
            color: #888;
            transition: all 0.2s;
        }
        .login-tab.active {
            border-color: #667eea;
            color: #667eea;
            font-weight: bold;
        }
        .login-form { display: none; }
        .login-form.active { display: block; }
        .input-group {
            margin-bottom: 15px;
        }
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
            color: #666;
        }
        .input-group input, .input-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
            outline: none;
            transition: border-color 0.2s;
        }
        .input-group input:focus, .input-group select:focus {
            border-color: #667eea;
        }
        .input-hint {
            font-size: 12px;
            color: #999;
            margin-top: 4px;
        }
        .login-btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 10px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: #fff;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
        }
        .login-btn:hover { opacity: 0.9; }
        .skip-btn {
            display: block;
            text-align: center;
            margin-top: 15px;
            color: #667eea;
            cursor: pointer;
            font-size: 14px;
        }
        
        /* ä¸»å®¹å™¨ */
        .main-container {
            display: flex;
            margin-top: 60px;
            height: calc(100vh - 60px);
        }
        
        /* å·¦å´ï¼šè§’è‰²å€ */
        .character-panel {
            width: 320px;
            background: rgba(255,255,255,0.03);
            padding: 15px;
            display: flex;
            flex-direction: column;
        }
        .character-preview {
            position: relative;
            width: 280px;
            height: 400px;
            background: linear-gradient(180deg, #87CEEB 0%, #98FB98 100%);
            border-radius: 12px;
            margin: 0 auto;
            overflow: hidden;
        }
        .character-preview img {
            position: absolute;
            top: -50px;
            left: -30px;
            width: 340px;
            height: 500px;
            object-fit: contain;
        }
        .char-name {
            text-align: center;
            margin-top: 10px;
            font-size: 18px;
            color: #ffd700;
        }
        .char-level {
            text-align: center;
            font-size: 14px;
            color: #888;
        }
        
        /* å°èˆªæŒ‰éˆ• */
        .nav-buttons {
            display: flex;
            gap: 8px;
            margin-top: 15px;
        }
        .nav-btn {
            flex: 1;
            padding: 12px 8px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: bold;
            transition: all 0.2s;
        }
        .nav-btn.quiz { background: linear-gradient(135deg, #4CAF50, #8BC34A); color: #fff; }
        .nav-btn.shop { background: linear-gradient(135deg, #ffd700, #ff9800); color: #000; }
        .nav-btn.equip { background: linear-gradient(135deg, #2196F3, #03A9F4); color: #fff; }
        .nav-btn:hover { transform: scale(1.02); }
        .nav-btn.active { box-shadow: 0 0 15px rgba(255,255,255,0.5); }
        
        /* å³å´ï¼šä¸»å…§å®¹å€ */
        .content-panel {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        
        /* ç­”é¡Œå€ */
        .quiz-area {
            max-width: 700px;
            margin: 0 auto;
        }
        .quiz-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .quiz-title {
            font-size: 24px;
            color: #4CAF50;
        }
        .difficulty-badge {
            padding: 6px 16px;
            border-radius: 20px;
            font-weight: bold;
        }
        .difficulty-badge.basic { background: #4CAF50; }
        .difficulty-badge.intermediate { background: #FF9800; }
        .difficulty-badge.advanced { background: #f44336; }
        
        .question-card {
            background: rgba(255,255,255,0.1);
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 20px;
        }
        .question-number {
            color: #888;
            font-size: 14px;
            margin-bottom: 10px;
        }
        .question-text {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 25px;
            line-height: 1.4;
        }
        .question-text .highlight {
            color: #ffd700;
        }
        
        .answer-input {
            width: 100%;
            padding: 15px 20px;
            font-size: 24px;
            border: 3px solid #444;
            border-radius: 12px;
            background: rgba(0,0,0,0.3);
            color: #fff;
            text-align: center;
            outline: none;
            transition: border-color 0.2s;
        }
        .answer-input:focus {
            border-color: #4CAF50;
        }
        .answer-input.correct {
            border-color: #4CAF50;
            background: rgba(76, 175, 80, 0.2);
        }
        .answer-input.wrong {
            border-color: #f44336;
            background: rgba(244, 67, 54, 0.2);
        }
        
        .submit-btn {
            width: 100%;
            padding: 15px;
            font-size: 20px;
            font-weight: bold;
            border: none;
            border-radius: 12px;
            background: linear-gradient(135deg, #4CAF50, #8BC34A);
            color: #fff;
            cursor: pointer;
            margin-top: 15px;
            transition: transform 0.2s;
        }
        .submit-btn:hover { transform: scale(1.02); }
        .submit-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .option-btn {
            padding: 12px 20px;
            font-size: 18px;
            border: 2px solid #444;
            border-radius: 10px;
            background: rgba(255,255,255,0.1);
            color: #fff;
            cursor: pointer;
            transition: all 0.2s;
            min-width: 120px;
        }
        .option-btn:hover {
            border-color: #4CAF50;
            background: rgba(76, 175, 80, 0.2);
            transform: scale(1.02);
        }
        
        .result-feedback {
            text-align: center;
            padding: 20px;
            border-radius: 12px;
            margin-top: 15px;
            font-size: 20px;
            font-weight: bold;
        }
        .result-feedback.correct {
            background: rgba(76, 175, 80, 0.2);
            color: #4CAF50;
        }
        .result-feedback.wrong {
            background: rgba(244, 67, 54, 0.2);
            color: #f44336;
        }
        
        /* å•†åº—å€ */
        .shop-area { display: none; }
        .shop-area.active { display: block; }
        .shop-title {
            font-size: 24px;
            color: #ffd700;
            margin-bottom: 20px;
            text-align: center;
        }
        .shop-category {
            margin-bottom: 25px;
        }
        .shop-category-title {
            font-size: 16px;
            color: #888;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid #333;
        }
        .shop-items {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 12px;
        }
        .shop-item {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        .shop-item:hover { border-color: #ffd700; transform: translateY(-2px); }
        .shop-item.owned { border-color: #4CAF50; }
        .shop-item.equipped { border-color: #2196F3; box-shadow: 0 0 10px rgba(33,150,243,0.5); }
        .shop-item-img {
            width: 80px;
            height: 80px;
            object-fit: contain;
            margin-bottom: 8px;
        }
        .shop-item-name {
            font-size: 13px;
            margin-bottom: 5px;
        }
        .shop-item-price {
            font-size: 14px;
            color: #ffd700;
            font-weight: bold;
        }
        .shop-item-price.owned { color: #4CAF50; }
        
        /* è£å‚™å¼·åŒ–å€ */
        .equip-area { display: none; }
        .equip-area.active { display: block; }
        .enhance-panel {
            background: rgba(255,255,255,0.05);
            border-radius: 16px;
            padding: 25px;
            max-width: 500px;
            margin: 0 auto;
        }
        .enhance-title {
            font-size: 20px;
            color: #ff9800;
            text-align: center;
            margin-bottom: 20px;
        }
        .enhance-item-display {
            text-align: center;
            padding: 20px;
            background: rgba(0,0,0,0.3);
            border-radius: 12px;
            margin-bottom: 20px;
        }
        .enhance-item-img {
            width: 120px;
            height: 120px;
            object-fit: contain;
        }
        .enhance-item-name {
            font-size: 18px;
            margin-top: 10px;
        }
        .enhance-item-level {
            font-size: 24px;
            color: #ffd700;
            font-weight: bold;
            margin-top: 5px;
        }
        .enhance-rate {
            text-align: center;
            margin-bottom: 15px;
        }
        .enhance-rate-bar {
            height: 20px;
            background: #333;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 8px;
        }
        .enhance-rate-fill {
            height: 100%;
            background: linear-gradient(90deg, #f44336, #ff9800, #4CAF50);
            transition: width 0.3s;
        }
        .enhance-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .enhance-btn {
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .enhance-btn.basic { background: #555; color: #fff; }
        .enhance-btn.advanced { background: #2196F3; color: #fff; }
        .enhance-btn.blessed { background: #9C27B0; color: #fff; }
        .enhance-btn:hover { opacity: 0.9; }
        .enhance-btn:disabled { opacity: 0.4; cursor: not-allowed; }
        
        /* å½ˆå‡ºé€šçŸ¥ */
        .popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            padding: 40px 60px;
            border-radius: 20px;
            font-size: 32px;
            font-weight: bold;
            z-index: 1000;
            animation: popIn 0.5s forwards;
        }
        @keyframes popIn {
            0% { transform: translate(-50%, -50%) scale(0); }
            50% { transform: translate(-50%, -50%) scale(1.1); }
            100% { transform: translate(-50%, -50%) scale(1); }
        }
        .popup.success { background: linear-gradient(135deg, #4CAF50, #8BC34A); }
        .popup.fail { background: linear-gradient(135deg, #f44336, #ff5722); }
        .popup.reward { background: linear-gradient(135deg, #ffd700, #ff9800); color: #000; }
        
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 999;
        }
        
        /* æ¯æ—¥ä»»å‹™ */
        .daily-missions {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 15px;
            margin-top: 15px;
        }
        .daily-title {
            font-size: 14px;
            color: #888;
            margin-bottom: 10px;
        }
        .mission-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #333;
            font-size: 13px;
        }
        .mission-item:last-child { border-bottom: none; }
        .mission-progress {
            color: #4CAF50;
        }
        .mission-reward {
            color: #ffd700;
            font-weight: bold;
        }
        .mission-item.completed {
            color: #666;
            text-decoration: line-through;
        }
        .mission-item.completed .mission-reward {
            color: #4CAF50;
        }
        
        /* éš±è—å…ƒç´  */
        .hidden { display: none !important; }
        
        /* Quiz Area Active */
        .quiz-area { display: none; }
        .quiz-area.active { display: block; }
    </style>
</head>
<body>
    <!-- ç™»å…¥ç•«é¢ -->
    <div class="login-screen" id="loginScreen">
        <div class="login-box">
            <div class="login-title">ğŸ§® æ•¸å­¸å†’éšª</div>
            <div class="login-tabs">
                <div class="login-tab active" onclick="showLoginTab('login')">ç™»å…¥</div>
                <div class="login-tab" onclick="showLoginTab('register')">è¨»å†Š</div>
            </div>
            
            <!-- ç™»å…¥è¡¨å–® -->
            <div class="login-form active" id="loginFormTab">
                <div class="input-group">
                    <label>ğŸ‘¤ æš±ç¨±</label>
                    <input type="text" id="loginNickname" placeholder="è¼¸å…¥ä½ çš„æš±ç¨±">
                </div>
                <div class="input-group">
                    <label>ğŸ”‘ 4ä½æ•¸å¯†ç¢¼</label>
                    <input type="password" id="loginPin" maxlength="4" placeholder="è¼¸å…¥å¯†ç¢¼">
                </div>
                <button class="login-btn" onclick="doLogin()">ç™»å…¥</button>
            </div>
            
            <!-- è¨»å†Šè¡¨å–® -->
            <div class="login-form" id="registerFormTab">
                <div class="input-group">
                    <label>ğŸ‘¤ æš±ç¨±</label>
                    <input type="text" id="regNickname" placeholder="å–ä¸€å€‹ç¨ç‰¹çš„æš±ç¨±">
                    <div class="input-hint">2-10å€‹å­—ï¼Œä¸å¯é‡è¤‡</div>
                </div>
                <div class="input-group">
                    <label>ğŸ“ ç¸£å¸‚</label>
                    <select id="regCity">
                        <option value="">è«‹é¸æ“‡</option>
                        <option value="å°åŒ—å¸‚">å°åŒ—å¸‚</option>
                        <option value="æ–°åŒ—å¸‚">æ–°åŒ—å¸‚</option>
                        <option value="æ¡ƒåœ’å¸‚">æ¡ƒåœ’å¸‚</option>
                        <option value="å°ä¸­å¸‚">å°ä¸­å¸‚</option>
                        <option value="å°å—å¸‚">å°å—å¸‚</option>
                        <option value="é«˜é›„å¸‚">é«˜é›„å¸‚</option>
                        <option value="åŸºéš†å¸‚">åŸºéš†å¸‚</option>
                        <option value="æ–°ç«¹å¸‚">æ–°ç«¹å¸‚</option>
                        <option value="æ–°ç«¹ç¸£">æ–°ç«¹ç¸£</option>
                        <option value="è‹—æ —ç¸£">è‹—æ —ç¸£</option>
                        <option value="å½°åŒ–ç¸£">å½°åŒ–ç¸£</option>
                        <option value="å—æŠ•ç¸£">å—æŠ•ç¸£</option>
                        <option value="é›²æ—ç¸£">é›²æ—ç¸£</option>
                        <option value="å˜‰ç¾©å¸‚">å˜‰ç¾©å¸‚</option>
                        <option value="å˜‰ç¾©ç¸£">å˜‰ç¾©ç¸£</option>
                        <option value="å±æ±ç¸£">å±æ±ç¸£</option>
                        <option value="å®œè˜­ç¸£">å®œè˜­ç¸£</option>
                        <option value="èŠ±è“®ç¸£">èŠ±è“®ç¸£</option>
                        <option value="å°æ±ç¸£">å°æ±ç¸£</option>
                        <option value="æ¾æ¹–ç¸£">æ¾æ¹–ç¸£</option>
                        <option value="é‡‘é–€ç¸£">é‡‘é–€ç¸£</option>
                        <option value="é€£æ±Ÿç¸£">é€£æ±Ÿç¸£</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>ğŸ“– å¹´ç´š</label>
                    <select id="regGrade">
                        <option value="1">ä¸€å¹´ç´š</option>
                        <option value="2">äºŒå¹´ç´š</option>
                        <option value="3">ä¸‰å¹´ç´š</option>
                        <option value="4">å››å¹´ç´š</option>
                        <option value="5">äº”å¹´ç´š</option>
                        <option value="6">å…­å¹´ç´š</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>ğŸ”‘ è¨­å®š4ä½æ•¸å¯†ç¢¼</label>
                    <input type="password" id="regPin" maxlength="4" placeholder="è¨­å®šå¯†ç¢¼ï¼ˆ4ä½æ•¸å­—ï¼‰">
                    <div class="input-hint">è«‹è¨˜ä½å¯†ç¢¼ï¼</div>
                </div>
                <button class="login-btn" onclick="doRegister()">è¨»å†Š</button>
            </div>
            
            <div class="skip-btn" onclick="skipLogin()">å…ˆè©¦ç©ï¼Œä¸è¨»å†Š â†’</div>
        </div>
    </div>

    <!-- ç‹€æ…‹åˆ— -->
    <div class="status-bar">
        <div class="status-item">
            ğŸ’° ç©åˆ†: <span class="value" id="pointsDisplay">0</span>
        </div>
        <div class="status-item">
            ğŸ”¥ é€£å‹: <span class="value streak-fire" id="streakDisplay">0</span>
        </div>
        <div class="status-item">
            ğŸ“Š ä»Šæ—¥ç­”é¡Œ: <span class="value" id="todayCount">0</span>/50
        </div>
        <div class="status-item">
            â­ æ­£ç¢ºç‡: <span class="value" id="accuracyDisplay">0%</span>
        </div>
    </div>

    <div class="main-container">
        <!-- å·¦å´è§’è‰²é¢æ¿ -->
        <div class="character-panel">
            <div class="character-preview" id="characterPreview">
                <!-- è§’è‰²åœ–å±¤ -->
            </div>
            <div class="char-name" id="charName">å°å°æ•¸å­¸å®¶</div>
            <div class="char-level">Lv. <span id="charLevel">1</span></div>
            
            <div class="nav-buttons">
                <button class="nav-btn quiz active" onclick="showPanel('quiz')">ğŸ“ ç­”é¡Œ</button>
                <button class="nav-btn shop" onclick="showPanel('shop')">ğŸ›’ å•†åº—</button>
                <button class="nav-btn equip" onclick="showPanel('equip')">âš”ï¸ å¼·åŒ–</button>
            </div>
            
            <div class="daily-missions">
                <div class="daily-title">ğŸ“‹ æ¯æ—¥ä»»å‹™</div>
                <div class="mission-item" id="mission1">
                    <span>ç­”å° 10 é¡Œ</span>
                    <span class="mission-progress">0/10</span>
                    <span class="mission-reward">+50ğŸ’°</span>
                </div>
                <div class="mission-item" id="mission2">
                    <span>é€£å‹ 5 é¡Œ</span>
                    <span class="mission-progress">0/5</span>
                    <span class="mission-reward">+30ğŸ’°</span>
                </div>
                <div class="mission-item" id="mission3">
                    <span>å®Œæˆ 20 é¡Œ</span>
                    <span class="mission-progress">0/20</span>
                    <span class="mission-reward">+80ğŸ’°</span>
                </div>
            </div>
        </div>

        <!-- å³å´å…§å®¹å€ -->
        <div class="content-panel">
            <!-- ç­”é¡Œå€ -->
            <div class="quiz-area active" id="quizArea">
                <div class="quiz-header">
                    <div class="quiz-title">ğŸ“ æ•¸å­¸ç·´ç¿’</div>
                    <div class="difficulty-badge basic" id="difficultyBadge">åŸºç¤</div>
                </div>
                
                <div class="question-card">
                    <div class="question-number">ç¬¬ <span id="questionNum">1</span> é¡Œ</div>
                    <div class="question-text" id="questionText">è¼‰å…¥ä¸­...</div>
                    <div id="optionsContainer" style="display: none; flex-wrap: wrap; gap: 10px; margin-bottom: 15px;"></div>
                    <input type="text" class="answer-input" id="answerInput" placeholder="è¼¸å…¥ç­”æ¡ˆï¼ˆåªå¡«æ•¸å­—ï¼‰" autocomplete="off">
                    <button class="submit-btn" id="submitBtn" onclick="submitAnswer()">ç¢ºèªç­”æ¡ˆ</button>
                    <div class="result-feedback hidden" id="resultFeedback"></div>
                </div>
                
                <div style="text-align: center; margin-top: 15px;">
                    <button onclick="setDifficulty('basic')" style="padding: 8px 16px; margin: 0 5px; border-radius: 8px; border: none; cursor: pointer; background: #4CAF50; color: #fff;">åŸºç¤ (+5åˆ†)</button>
                    <button onclick="setDifficulty('intermediate')" style="padding: 8px 16px; margin: 0 5px; border-radius: 8px; border: none; cursor: pointer; background: #FF9800; color: #fff;">é€²éš (+10åˆ†)</button>
                    <button onclick="setDifficulty('advanced')" style="padding: 8px 16px; margin: 0 5px; border-radius: 8px; border: none; cursor: pointer; background: #f44336; color: #fff;">æŒ‘æˆ° (+20åˆ†)</button>
                </div>
            </div>

            <!-- å•†åº—å€ -->
            <div class="shop-area" id="shopArea">
                <div class="shop-title">ğŸ›’ è£å‚™å•†åº—</div>
                
                <div class="shop-category">
                    <div class="shop-category-title">âš”ï¸ æ­¦å™¨</div>
                    <div class="shop-items" id="weaponShop"></div>
                </div>
                
                <div class="shop-category">
                    <div class="shop-category-title">ğŸ›¡ï¸ é˜²å…·</div>
                    <div class="shop-items" id="armorShop"></div>
                </div>
                
                <div class="shop-category">
                    <div class="shop-category-title">ğŸ’ é£¾å“</div>
                    <div class="shop-items" id="accessoryShop"></div>
                </div>
                
                <div class="shop-category">
                    <div class="shop-category-title">ğŸ¦‹ ç¿…è†€</div>
                    <div class="shop-items" id="wingsShop"></div>
                </div>
                
                <div class="shop-category">
                    <div class="shop-category-title">ğŸ“œ å¼·åŒ–æ²è»¸</div>
                    <div class="shop-items" id="scrollShop"></div>
                </div>
            </div>

            <!-- å¼·åŒ–å€ -->
            <div class="equip-area" id="equipArea">
                <div class="enhance-panel">
                    <div class="enhance-title">âš¡ è£å‚™å¼·åŒ–</div>
                    <div class="enhance-item-display">
                        <img class="enhance-item-img" id="enhanceItemImg" src="">
                        <div class="enhance-item-name" id="enhanceItemName">è«‹é¸æ“‡è£å‚™</div>
                        <div class="enhance-item-level" id="enhanceItemLevel">+0</div>
                    </div>
                    <div class="enhance-rate">
                        <span>æˆåŠŸç‡: <strong id="enhanceRate">-</strong></span>
                        <div class="enhance-rate-bar">
                            <div class="enhance-rate-fill" id="enhanceRateFill" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="enhance-buttons">
                        <button class="enhance-btn basic" onclick="doEnhance('basic')" id="enhanceBasicBtn">
                            <span>ğŸ“œ åŸºç¤å¼·åŒ–</span>
                            <span>æ¶ˆè€—: 1xåŸºç¤æ²è»¸</span>
                        </button>
                        <button class="enhance-btn advanced" onclick="doEnhance('advanced')" id="enhanceAdvBtn">
                            <span>ğŸ“œ é€²éšå¼·åŒ– (+10%)</span>
                            <span>æ¶ˆè€—: 1xé€²éšæ²è»¸</span>
                        </button>
                        <button class="enhance-btn blessed" onclick="doEnhance('blessed')" id="enhanceBlessBtn">
                            <span>ğŸ“œ ç¥ç¦å¼·åŒ– (ä¸é™ç´š)</span>
                            <span>æ¶ˆè€—: 1xç¥ç¦æ²è»¸</span>
                        </button>
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <div style="color: #888; font-size: 14px; margin-bottom: 10px;">é¸æ“‡è¦å¼·åŒ–çš„è£å‚™:</div>
                        <div id="ownedEquipList" style="display: flex; flex-wrap: wrap; gap: 8px;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== ç”¨æˆ¶ç³»çµ± ====================
        let currentUser = null;
        const STORAGE_KEY = 'mathAdventureUsers';
        const SESSION_KEY = 'mathAdventureSession';
        
        function getUsers() {
            return JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
        }
        
        function saveUsers(users) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(users));
        }
        
        function showLoginTab(tab) {
            document.querySelectorAll('.login-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.login-form').forEach(f => f.classList.remove('active'));
            
            if (tab === 'login') {
                document.querySelector('.login-tab:first-child').classList.add('active');
                document.getElementById('loginFormTab').classList.add('active');
            } else {
                document.querySelector('.login-tab:last-child').classList.add('active');
                document.getElementById('registerFormTab').classList.add('active');
            }
        }
        
        function doLogin() {
            const nickname = document.getElementById('loginNickname').value.trim();
            const pin = document.getElementById('loginPin').value;
            
            if (!nickname || !pin) {
                alert('è«‹è¼¸å…¥æš±ç¨±å’Œå¯†ç¢¼');
                return;
            }
            
            const users = getUsers();
            const user = users[nickname];
            
            if (!user) {
                alert('æ‰¾ä¸åˆ°æ­¤ç”¨æˆ¶ï¼Œè«‹å…ˆè¨»å†Š');
                return;
            }
            
            if (user.pin !== pin) {
                alert('å¯†ç¢¼éŒ¯èª¤');
                return;
            }
            
            // ç™»å…¥æˆåŠŸ
            currentUser = user;
            localStorage.setItem(SESSION_KEY, nickname);
            loadUserData();
            hideLogin();
        }
        
        function doRegister() {
            const nickname = document.getElementById('regNickname').value.trim();
            const city = document.getElementById('regCity').value;
            const grade = document.getElementById('regGrade').value;
            const pin = document.getElementById('regPin').value;
            
            if (!nickname || nickname.length < 2 || nickname.length > 10) {
                alert('æš±ç¨±éœ€è¦2-10å€‹å­—');
                return;
            }
            
            if (!/^\d{4}$/.test(pin)) {
                alert('å¯†ç¢¼éœ€è¦4ä½æ•¸å­—');
                return;
            }
            
            const users = getUsers();
            
            if (users[nickname]) {
                alert('æ­¤æš±ç¨±å·²è¢«ä½¿ç”¨');
                return;
            }
            
            // å‰µå»ºæ–°ç”¨æˆ¶
            const newUser = {
                nickname: nickname,
                city: city,
                grade: parseInt(grade),
                pin: pin,
                points: 100,
                streak: 0,
                maxStreak: 0,
                todayCorrect: 0,
                todayTotal: 0,
                totalCorrect: 0,
                totalQuestions: 0,
                owned: [],
                equipment: { weapon: null, armor: null, accessory: null, wings: null },
                enhanceLevels: {},
                scrolls: { basic: 2, advanced: 0, blessed: 0 },
                character: {
                    body: 'basics_body1.png',
                    hair: 'basics_hairA_1.png',
                    eyes: 'basics_eyes1.png',
                    eyebrow: 'basics_eyebrow1.png',
                    eyelashes: 'basics_eyelashes1.png',
                    mouth: 'basics_mouth1.png',
                    top: 'basics_top1.png',
                    bottom: 'basics_bottom1.png',
                    shoes: 'basics_shoes1.png',
                },
                createdAt: Date.now()
            };
            
            users[nickname] = newUser;
            saveUsers(users);
            
            currentUser = newUser;
            localStorage.setItem(SESSION_KEY, nickname);
            loadUserData();
            hideLogin();
            
            alert(`ğŸ‰ è¨»å†ŠæˆåŠŸï¼æ­¡è¿ ${nickname}ï¼`);
        }
        
        function skipLogin() {
            // è¨ªå®¢æ¨¡å¼
            currentUser = {
                nickname: 'è¨ªå®¢',
                city: '',
                grade: 3,
                points: 100,
                streak: 0,
                maxStreak: 0,
                todayCorrect: 0,
                todayTotal: 0,
                totalCorrect: 0,
                totalQuestions: 0,
                owned: [],
                equipment: { weapon: null, armor: null, accessory: null, wings: null },
                enhanceLevels: {},
                scrolls: { basic: 2, advanced: 0, blessed: 0 },
                character: {
                    body: 'basics_body1.png',
                    hair: 'basics_hairA_1.png',
                    eyes: 'basics_eyes1.png',
                    eyebrow: 'basics_eyebrow1.png',
                    eyelashes: 'basics_eyelashes1.png',
                    mouth: 'basics_mouth1.png',
                    top: 'basics_top1.png',
                    bottom: 'basics_bottom1.png',
                    shoes: 'basics_shoes1.png',
                },
                isGuest: true
            };
            loadUserData();
            hideLogin();
        }
        
        function loadUserData() {
            if (!currentUser) return;
            
            // æŠŠç”¨æˆ¶è³‡æ–™è¼‰å…¥ gameData
            gameData.points = currentUser.points || 100;
            gameData.streak = currentUser.streak || 0;
            gameData.maxStreak = currentUser.maxStreak || 0;
            gameData.todayCorrect = currentUser.todayCorrect || 0;
            gameData.todayTotal = currentUser.todayTotal || 0;
            gameData.totalCorrect = currentUser.totalCorrect || 0;
            gameData.totalQuestions = currentUser.totalQuestions || 0;
            gameData.owned = currentUser.owned || [];
            gameData.equipment = currentUser.equipment || { weapon: null, armor: null, accessory: null, wings: null };
            gameData.enhanceLevels = currentUser.enhanceLevels || {};
            gameData.scrolls = currentUser.scrolls || { basic: 2, advanced: 0, blessed: 0 };
            gameData.character = currentUser.character || gameData.character;
            
            // æ›´æ–°è§’è‰²åç¨±
            document.getElementById('charName').textContent = currentUser.nickname;
            if (currentUser.city) {
                document.getElementById('charLevel').innerHTML = `ğŸ“ ${currentUser.city} | Lv. <span id="charLevelNum">${Math.floor(gameData.totalCorrect / 20) + 1}</span>`;
            }
        }
        
        function saveUserData() {
            if (!currentUser || currentUser.isGuest) return;
            
            // æ›´æ–°ç”¨æˆ¶è³‡æ–™
            currentUser.points = gameData.points;
            currentUser.streak = gameData.streak;
            currentUser.maxStreak = gameData.maxStreak;
            currentUser.todayCorrect = gameData.todayCorrect;
            currentUser.todayTotal = gameData.todayTotal;
            currentUser.totalCorrect = gameData.totalCorrect;
            currentUser.totalQuestions = gameData.totalQuestions;
            currentUser.owned = gameData.owned;
            currentUser.equipment = gameData.equipment;
            currentUser.enhanceLevels = gameData.enhanceLevels;
            currentUser.scrolls = gameData.scrolls;
            currentUser.character = gameData.character;
            
            // å­˜å…¥ localStorage
            const users = getUsers();
            users[currentUser.nickname] = currentUser;
            saveUsers(users);
        }
        
        function hideLogin() {
            document.getElementById('loginScreen').classList.add('hidden');
            initGame();
        }
        
        function checkSession() {
            const savedNickname = localStorage.getItem(SESSION_KEY);
            if (savedNickname) {
                const users = getUsers();
                if (users[savedNickname]) {
                    currentUser = users[savedNickname];
                    loadUserData();
                    hideLogin();
                    return true;
                }
            }
            return false;
        }
        
        // ==================== éŠæˆ²æ•¸æ“š ====================
        let gameData = {
            points: 100,
            streak: 0,
            maxStreak: 0,
            todayCorrect: 0,
            todayTotal: 0,
            totalCorrect: 0,
            totalQuestions: 0,
            level: 1,
            exp: 0,
            
            character: {
                body: 'basics_body1.png',
                hair: 'basics_hairA_1.png',
                eyes: 'basics_eyes1.png',
                eyebrow: 'basics_eyebrow1.png',
                eyelashes: 'basics_eyelashes1.png',
                mouth: 'basics_mouth1.png',
                top: 'basics_top1.png',
                bottom: 'basics_bottom1.png',
                shoes: 'basics_shoes1.png',
            },
            
            equipment: {
                weapon: null,
                armor: null,
                accessory: null,
                wings: null,
            },
            
            owned: [],
            enhanceLevels: {},
            
            scrolls: {
                basic: 2,
                advanced: 0,
                blessed: 0,
            },
            
            missions: {
                correct10: { current: 0, target: 10, reward: 50, completed: false },
                streak5: { current: 0, target: 5, reward: 30, completed: false },
                total20: { current: 0, target: 20, reward: 80, completed: false },
            }
        };

        // è£å‚™å•†åº—æ•¸æ“š
        const shopItems = {
            weapon: [
                { id: 'item_pencil', name: 'é‰›ç­†', price: 80, img: 'equipment/basic/item_pencil.png' },
                { id: 'item_book', name: 'é­”æ³•æ›¸', price: 150, img: 'equipment/basic/item_book.png' },
                { id: 'item_magic_wand', name: 'é­”æ³•æ£’', price: 250, img: 'equipment/basic/item_magic_wand.png' },
                { id: 'k12_staff', name: 'Ï€æ¬Šæ–', price: 600, img: 'equipment/brand/k12_staff.png' },
            ],
            armor: [
                { id: 'scarf_red', name: 'ç´…åœå·¾', price: 100, img: 'equipment/basic/scarf_red.png' },
                { id: 'scarf_rainbow', name: 'å½©è™¹åœå·¾', price: 200, img: 'equipment/basic/scarf_rainbow.png' },
                { id: 'oikid_cape', name: 'OiKIDæŠ«é¢¨', price: 500, img: 'equipment/brand/oikid_cape.png' },
                { id: 'k12_cape', name: 'æ•¸å­¸æ–—ç¯·', price: 500, img: 'equipment/brand/k12_cape.png' },
            ],
            accessory: [
                { id: 'glasses_round', name: 'åœ“çœ¼é¡', price: 80, img: 'equipment/basic/glasses_round.png' },
                { id: 'glasses_heart', name: 'æ„›å¿ƒçœ¼é¡', price: 150, img: 'equipment/basic/glasses_heart.png' },
                { id: 'hat_cat_ears', name: 'è²“è€³æœµ', price: 200, img: 'equipment/basic/hat_cat_ears.png' },
                { id: 'hat_crown_gold', name: 'é‡‘çš‡å† ', price: 400, img: 'equipment/basic/hat_crown_gold.png' },
                { id: 'hat_wizard', name: 'å·«å¸«å¸½', price: 350, img: 'equipment/basic/hat_wizard.png' },
            ],
            wings: [
                { id: 'wings_bat', name: 'è™è ç¿…è†€', price: 500, img: 'equipment/basic/wings_bat.png' },
                { id: 'wings_butterfly', name: 'è´è¶ç¿…è†€', price: 600, img: 'equipment/basic/wings_butterfly.png' },
                { id: 'wings_angel', name: 'å¤©ä½¿ç¿…è†€', price: 800, img: 'equipment/basic/wings_angel.png' },
            ],
            scroll: [
                { id: 'scroll_basic', name: 'åŸºç¤æ²è»¸', price: 100, img: null, type: 'basic' },
                { id: 'scroll_advanced', name: 'é€²éšæ²è»¸', price: 300, img: null, type: 'advanced' },
                { id: 'scroll_blessed', name: 'ç¥ç¦æ²è»¸', price: 500, img: null, type: 'blessed' },
            ]
        };

        // å¼·åŒ–æˆåŠŸç‡
        const enhanceRates = {
            1: 95, 2: 90, 3: 85, 4: 75, 5: 65, 
            6: 50, 7: 35, 8: 20, 9: 10, 10: 5
        };

        // ç•¶å‰ç‹€æ…‹
        let currentDifficulty = 'basic';
        let currentQuestion = null;
        let selectedEnhanceItem = null;
        let questionNumber = 1;

        // ==================== é¡Œåº«æ•¸æ“š ====================
        let questionBank = null;
        let usedQuestions = new Set(); // è¨˜éŒ„å·²å‡ºéçš„é¡Œç›®ï¼Œé¿å…é‡è¤‡
        
        // è¼‰å…¥é¡Œåº«
        async function loadQuestionBank() {
            try {
                const response = await fetch('questions.json');
                questionBank = await response.json();
                console.log('é¡Œåº«è¼‰å…¥æˆåŠŸï¼å…±', Object.values(questionBank).reduce((sum, g) => sum + g.questions.length, 0), 'é¡Œ');
            } catch (e) {
                console.error('é¡Œåº«è¼‰å…¥å¤±æ•—:', e);
                // è¼‰å…¥å¤±æ•—æ™‚ä½¿ç”¨å‚™ç”¨é¡Œç›®
                questionBank = null;
            }
        }
        
        // ==================== é¡Œç›®ç”Ÿæˆ ====================
        function generateQuestion(difficulty) {
            // å¦‚æœé¡Œåº«æ²’è¼‰å…¥ï¼Œä½¿ç”¨ç°¡å–®å‚™ç”¨é¡Œç›®
            if (!questionBank) {
                return generateFallbackQuestion(difficulty);
            }
            
            // æ ¹æ“šé›£åº¦é¸æ“‡å¹´ç´š
            let grades;
            if (difficulty === 'basic') {
                grades = ['grade1', 'grade2'];
            } else if (difficulty === 'intermediate') {
                grades = ['grade3', 'grade4'];
            } else {
                grades = ['grade5', 'grade6'];
            }
            
            // éš¨æ©Ÿé¸æ“‡å¹´ç´š
            const gradeKey = grades[Math.floor(Math.random() * grades.length)];
            const gradeData = questionBank[gradeKey];
            
            if (!gradeData || !gradeData.questions || gradeData.questions.length === 0) {
                return generateFallbackQuestion(difficulty);
            }
            
            // éš¨æ©Ÿé¸æ“‡é¡Œç›®ï¼ˆé¿å…é‡è¤‡ï¼‰
            let attempts = 0;
            let question;
            do {
                const idx = Math.floor(Math.random() * gradeData.questions.length);
                question = gradeData.questions[idx];
                const qId = gradeKey + '_' + idx;
                if (!usedQuestions.has(qId) || usedQuestions.size > gradeData.questions.length * 0.8) {
                    usedQuestions.add(qId);
                    break;
                }
                attempts++;
            } while (attempts < 10);
            
            // å¦‚æœç”¨å®Œäº†å¤§éƒ¨åˆ†é¡Œç›®ï¼Œé‡ç½®
            if (usedQuestions.size > 1500) {
                usedQuestions.clear();
            }
            
            return {
                text: question.q,
                answer: String(question.answer).replace(/[å…ƒå€‹æœ¬ä»½æ’å¡Šé¡†éš»å¼µç‰‡æ¢ä»¶å°è¼›ç“¶è¢‹ç›’åŒ…çµ„é›™å°äººæ¬¡å¤©é€±æœˆå¹´]/g, '').trim(),
                difficulty: difficulty,
                scene: question.scene || null,
                sceneDesc: question.sceneDesc || null,
                tag: question.tag || null,
                options: question.options || null,
                explain: question.explain || null,
                grade: gradeData.name,
                fullAnswer: question.answer
            };
        }
        
        // å‚™ç”¨é¡Œç›®ç”Ÿæˆï¼ˆé¡Œåº«è¼‰å…¥å¤±æ•—æ™‚ä½¿ç”¨ï¼‰
        function generateFallbackQuestion(difficulty) {
            let a, b, answer, text;
            
            if (difficulty === 'basic') {
                a = Math.floor(Math.random() * 9) + 1;
                b = Math.floor(Math.random() * 9) + 1;
                answer = a * b;
                text = `${a} Ã— ${b} = ?`;
            } else if (difficulty === 'intermediate') {
                a = Math.floor(Math.random() * 50) + 20;
                b = Math.floor(Math.random() * 20) + 5;
                answer = a + b;
                text = `${a} + ${b} = ?`;
            } else {
                a = Math.floor(Math.random() * 100) + 50;
                b = Math.floor(Math.random() * 30) + 10;
                answer = a - b;
                text = `${a} - ${b} = ?`;
            }
            
            return { text, answer: String(answer), difficulty };
        }

        // ==================== ç­”é¡Œé‚è¼¯ ====================
        function loadQuestion() {
            currentQuestion = generateQuestion(currentDifficulty);
            
            // é¡¯ç¤ºé¡Œç›®
            let questionHtml = '';
            
            // å¦‚æœæœ‰å ´æ™¯æè¿°
            if (currentQuestion.scene) {
                questionHtml += `<div style="background: rgba(255,255,255,0.1); padding: 12px; border-radius: 8px; margin-bottom: 15px; font-size: 20px; white-space: pre-line;">${currentQuestion.scene}</div>`;
            }
            
            // é¡¯ç¤ºå¹´ç´šå’Œæ¨™ç±¤
            if (currentQuestion.grade || currentQuestion.tag) {
                questionHtml += `<div style="font-size: 12px; color: #888; margin-bottom: 8px;">`;
                if (currentQuestion.grade) questionHtml += `ğŸ“š ${currentQuestion.grade}`;
                if (currentQuestion.tag) questionHtml += ` | ğŸ·ï¸ ${currentQuestion.tag}`;
                questionHtml += `</div>`;
            }
            
            // é¡Œç›®æ–‡å­—
            questionHtml += `<div style="font-size: 22px; line-height: 1.6;">${currentQuestion.text}</div>`;
            
            document.getElementById('questionText').innerHTML = questionHtml;
            document.getElementById('questionNum').textContent = questionNumber;
            document.getElementById('answerInput').value = '';
            document.getElementById('answerInput').className = 'answer-input';
            document.getElementById('resultFeedback').classList.add('hidden');
            document.getElementById('submitBtn').disabled = false;
            
            // å¦‚æœæœ‰é¸é …ï¼Œé¡¯ç¤ºé¸é …æŒ‰éˆ•
            const optionsContainer = document.getElementById('optionsContainer');
            if (currentQuestion.options && currentQuestion.options.length > 0) {
                optionsContainer.innerHTML = currentQuestion.options.map((opt, i) => 
                    `<button class="option-btn" onclick="selectOption('${opt}')">${opt}</button>`
                ).join('');
                optionsContainer.style.display = 'flex';
                document.getElementById('answerInput').style.display = 'none';
            } else {
                optionsContainer.style.display = 'none';
                document.getElementById('answerInput').style.display = 'block';
                document.getElementById('answerInput').focus();
            }
        }
        
        function selectOption(opt) {
            document.getElementById('answerInput').value = opt;
            submitAnswer();
        }

        function submitAnswer() {
            const input = document.getElementById('answerInput');
            const userAnswer = input.value.trim();
            
            if (!userAnswer) return;
            
            // å½ˆæ€§ç­”æ¡ˆæ¯”å°ï¼ˆæ”¯æ´å¸¶å–®ä½çš„ç­”æ¡ˆï¼‰
            const normalizeAnswer = (ans) => {
                return String(ans)
                    .replace(/[å…ƒå€‹æœ¬ä»½æ’å¡Šé¡†éš»å¼µç‰‡æ¢ä»¶å°è¼›ç“¶è¢‹ç›’åŒ…çµ„é›™å°äººæ¬¡å¤©é€±æœˆå¹´å…¬åˆ†å…¬å°ºå…¬é‡Œå…¬æ–¤åº¦è§’]/g, '')
                    .replace(/\s+/g, '')
                    .trim();
            };
            
            const userNormalized = normalizeAnswer(userAnswer);
            const correctNormalized = normalizeAnswer(currentQuestion.answer);
            const fullNormalized = currentQuestion.fullAnswer ? normalizeAnswer(currentQuestion.fullAnswer) : correctNormalized;
            
            const isCorrect = userNormalized === correctNormalized || 
                             userNormalized === fullNormalized ||
                             userAnswer === currentQuestion.answer ||
                             userAnswer === currentQuestion.fullAnswer;
            
            // æ›´æ–°çµ±è¨ˆ
            gameData.todayTotal++;
            gameData.totalQuestions++;
            
            if (isCorrect) {
                gameData.todayCorrect++;
                gameData.totalCorrect++;
                gameData.streak++;
                if (gameData.streak > gameData.maxStreak) {
                    gameData.maxStreak = gameData.streak;
                }
                
                // è¨ˆç®—ç©åˆ†
                let points = { basic: 5, intermediate: 10, advanced: 20 }[currentDifficulty];
                
                // é€£å‹çå‹µ
                if (gameData.streak === 5) {
                    points += 15;
                    showPopup('ğŸ”¥ é€£å‹ 5 é¡Œï¼+15 çå‹µ', 'reward');
                } else if (gameData.streak === 10) {
                    points += 40;
                    showPopup('ğŸ”¥ğŸ”¥ é€£å‹ 10 é¡Œï¼+40 çå‹µ', 'reward');
                } else if (gameData.streak === 20) {
                    points += 100;
                    showPopup('ğŸ”¥ğŸ”¥ğŸ”¥ é€£å‹ 20 é¡Œï¼+100 çå‹µ', 'reward');
                }
                
                gameData.points += points;
                
                input.classList.add('correct');
                showFeedback(true, `æ­£ç¢ºï¼+${points} ç©åˆ†`);
            } else {
                gameData.streak = 0;
                input.classList.add('wrong');
                showFeedback(false, `éŒ¯èª¤ï¼`);
            }
            
            // æ›´æ–°ä»»å‹™é€²åº¦
            updateMissions(isCorrect);
            
            // æ›´æ–°é¡¯ç¤º
            updateDisplay();
            
            // ç¦ç”¨æäº¤æŒ‰éˆ•
            document.getElementById('submitBtn').disabled = true;
            
            // ä¿å­˜ç”¨æˆ¶è³‡æ–™
            saveUserData();
            
            // 1.5ç§’å¾Œè¼‰å…¥ä¸‹ä¸€é¡Œ
            setTimeout(() => {
                questionNumber++;
                loadQuestion();
            }, 1500);
        }

        function showFeedback(correct, message) {
            const feedback = document.getElementById('resultFeedback');
            feedback.className = 'result-feedback ' + (correct ? 'correct' : 'wrong');
            
            let html = message;
            
            // å¦‚æœç­”éŒ¯ï¼Œé¡¯ç¤ºæ­£ç¢ºç­”æ¡ˆ
            if (!correct && currentQuestion.fullAnswer) {
                html += `<br><span style="font-size: 16px;">æ­£ç¢ºç­”æ¡ˆï¼š${currentQuestion.fullAnswer}</span>`;
            }
            
            // é¡¯ç¤ºè§£æ
            if (currentQuestion.explain) {
                html += `<br><span style="font-size: 14px; color: #aaa;">ğŸ’¡ ${currentQuestion.explain}</span>`;
            }
            
            feedback.innerHTML = html;
            feedback.classList.remove('hidden');
        }

        function setDifficulty(diff) {
            currentDifficulty = diff;
            const badge = document.getElementById('difficultyBadge');
            badge.className = 'difficulty-badge ' + diff;
            badge.textContent = { basic: 'åŸºç¤', intermediate: 'é€²éš', advanced: 'æŒ‘æˆ°' }[diff];
            loadQuestion();
        }

        // ==================== ä»»å‹™ç³»çµ± ====================
        function updateMissions(wasCorrect) {
            if (wasCorrect && !gameData.missions.correct10.completed) {
                gameData.missions.correct10.current++;
                if (gameData.missions.correct10.current >= gameData.missions.correct10.target) {
                    gameData.missions.correct10.completed = true;
                    gameData.points += gameData.missions.correct10.reward;
                    showPopup(`âœ… ä»»å‹™å®Œæˆï¼+${gameData.missions.correct10.reward} ç©åˆ†`, 'reward');
                }
            }
            
            if (gameData.streak >= 5 && !gameData.missions.streak5.completed) {
                gameData.missions.streak5.current = 5;
                gameData.missions.streak5.completed = true;
                gameData.points += gameData.missions.streak5.reward;
                showPopup(`âœ… é€£å‹ä»»å‹™å®Œæˆï¼+${gameData.missions.streak5.reward} ç©åˆ†`, 'reward');
            } else if (!gameData.missions.streak5.completed) {
                gameData.missions.streak5.current = Math.max(gameData.missions.streak5.current, gameData.streak);
            }
            
            if (!gameData.missions.total20.completed) {
                gameData.missions.total20.current = gameData.todayTotal;
                if (gameData.missions.total20.current >= gameData.missions.total20.target) {
                    gameData.missions.total20.completed = true;
                    gameData.points += gameData.missions.total20.reward;
                    showPopup(`âœ… ä»»å‹™å®Œæˆï¼+${gameData.missions.total20.reward} ç©åˆ†`, 'reward');
                }
            }
            
            renderMissions();
        }

        function renderMissions() {
            const m1 = gameData.missions.correct10;
            const m2 = gameData.missions.streak5;
            const m3 = gameData.missions.total20;
            
            document.getElementById('mission1').innerHTML = `
                <span>ç­”å° 10 é¡Œ</span>
                <span class="mission-progress">${m1.current}/${m1.target}</span>
                <span class="mission-reward">${m1.completed ? 'âœ…' : '+50ğŸ’°'}</span>
            `;
            document.getElementById('mission1').className = 'mission-item' + (m1.completed ? ' completed' : '');
            
            document.getElementById('mission2').innerHTML = `
                <span>é€£å‹ 5 é¡Œ</span>
                <span class="mission-progress">${m2.current}/${m2.target}</span>
                <span class="mission-reward">${m2.completed ? 'âœ…' : '+30ğŸ’°'}</span>
            `;
            document.getElementById('mission2').className = 'mission-item' + (m2.completed ? ' completed' : '');
            
            document.getElementById('mission3').innerHTML = `
                <span>å®Œæˆ 20 é¡Œ</span>
                <span class="mission-progress">${m3.current}/${m3.target}</span>
                <span class="mission-reward">${m3.completed ? 'âœ…' : '+80ğŸ’°'}</span>
            `;
            document.getElementById('mission3').className = 'mission-item' + (m3.completed ? ' completed' : '');
        }

        // ==================== å•†åº—ç³»çµ± ====================
        function renderShop() {
            renderShopCategory('weaponShop', shopItems.weapon, 'weapon');
            renderShopCategory('armorShop', shopItems.armor, 'armor');
            renderShopCategory('accessoryShop', shopItems.accessory, 'accessory');
            renderShopCategory('wingsShop', shopItems.wings, 'wings');
            renderScrollShop();
        }

        function renderShopCategory(containerId, items, category) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            items.forEach(item => {
                const isOwned = gameData.owned.includes(item.id);
                const isEquipped = gameData.equipment[category] === item.id;
                
                const div = document.createElement('div');
                div.className = 'shop-item' + (isOwned ? ' owned' : '') + (isEquipped ? ' equipped' : '');
                
                div.innerHTML = `
                    <img class="shop-item-img" src="assets/${item.img}" onerror="this.style.display='none'">
                    <div class="shop-item-name">${item.name}</div>
                    <div class="shop-item-price ${isOwned ? 'owned' : ''}">${isOwned ? (isEquipped ? 'è£å‚™ä¸­' : 'å·²æ“æœ‰') : item.price + 'ğŸ’°'}</div>
                `;
                
                div.onclick = () => handleShopClick(item, category, isOwned, isEquipped);
                container.appendChild(div);
            });
        }

        function renderScrollShop() {
            const container = document.getElementById('scrollShop');
            container.innerHTML = '';
            
            shopItems.scroll.forEach(item => {
                const count = gameData.scrolls[item.type] || 0;
                
                const div = document.createElement('div');
                div.className = 'shop-item';
                div.innerHTML = `
                    <div style="font-size: 40px; margin-bottom: 5px;">ğŸ“œ</div>
                    <div class="shop-item-name">${item.name}</div>
                    <div style="font-size: 12px; color: #888;">æ“æœ‰: ${count}</div>
                    <div class="shop-item-price">${item.price}ğŸ’°</div>
                `;
                
                div.onclick = () => buyScroll(item);
                container.appendChild(div);
            });
        }

        function handleShopClick(item, category, isOwned, isEquipped) {
            if (!isOwned) {
                // è³¼è²·
                if (gameData.points >= item.price) {
                    if (confirm(`ç¢ºå®šè³¼è²· ${item.name}ï¼Ÿ\nèŠ±è²»: ${item.price} ç©åˆ†`)) {
                        gameData.points -= item.price;
                        gameData.owned.push(item.id);
                        gameData.equipment[category] = item.id;
                        showPopup(`ğŸ‰ ç²å¾— ${item.name}ï¼`, 'success');
                        updateDisplay();
                        renderShop();
                        updateCharacter();
                        saveUserData();
                    }
                } else {
                    alert('ç©åˆ†ä¸è¶³ï¼');
                }
            } else if (isEquipped) {
                // å¸ä¸‹
                gameData.equipment[category] = null;
                renderShop();
                updateCharacter();
                saveUserData();
            } else {
                // è£å‚™
                gameData.equipment[category] = item.id;
                renderShop();
                updateCharacter();
                saveUserData();
            }
        }

        function buyScroll(item) {
            if (gameData.points >= item.price) {
                gameData.points -= item.price;
                gameData.scrolls[item.type]++;
                showPopup(`ğŸ“œ ç²å¾— ${item.name}ï¼`, 'success');
                updateDisplay();
                renderScrollShop();
                saveUserData();
            } else {
                alert('ç©åˆ†ä¸è¶³ï¼');
            }
        }

        // ==================== å¼·åŒ–ç³»çµ± ====================
        function renderEnhancePanel() {
            const list = document.getElementById('ownedEquipList');
            list.innerHTML = '';
            
            // åˆ—å‡ºæ‰€æœ‰æ“æœ‰çš„å¯å¼·åŒ–è£å‚™
            ['weapon', 'armor', 'accessory'].forEach(cat => {
                shopItems[cat].forEach(item => {
                    if (gameData.owned.includes(item.id)) {
                        const level = gameData.enhanceLevels[item.id] || 0;
                        const div = document.createElement('div');
                        div.style.cssText = 'width: 60px; height: 60px; background: rgba(255,255,255,0.1); border-radius: 8px; cursor: pointer; position: relative; overflow: hidden;';
                        if (selectedEnhanceItem === item.id) {
                            div.style.border = '2px solid #ffd700';
                        }
                        
                        div.innerHTML = `
                            <img src="assets/${item.img}" style="width: 100%; height: 100%; object-fit: contain;">
                            ${level > 0 ? `<span style="position: absolute; top: 2px; left: 2px; background: #4CAF50; color: #fff; font-size: 10px; padding: 1px 4px; border-radius: 3px;">+${level}</span>` : ''}
                        `;
                        
                        div.onclick = () => selectEnhanceItem(item);
                        list.appendChild(div);
                    }
                });
            });
        }

        function selectEnhanceItem(item) {
            selectedEnhanceItem = item.id;
            
            const level = gameData.enhanceLevels[item.id] || 0;
            document.getElementById('enhanceItemImg').src = 'assets/' + item.img;
            document.getElementById('enhanceItemName').textContent = item.name;
            document.getElementById('enhanceItemLevel').textContent = '+' + level;
            
            if (level < 10) {
                const rate = enhanceRates[level + 1];
                document.getElementById('enhanceRate').textContent = rate + '%';
                document.getElementById('enhanceRateFill').style.width = rate + '%';
            } else {
                document.getElementById('enhanceRate').textContent = 'å·²æ»¿ç´š';
                document.getElementById('enhanceRateFill').style.width = '100%';
            }
            
            renderEnhancePanel();
            updateEnhanceButtons();
        }

        function updateEnhanceButtons() {
            document.getElementById('enhanceBasicBtn').disabled = gameData.scrolls.basic < 1;
            document.getElementById('enhanceAdvBtn').disabled = gameData.scrolls.advanced < 1;
            document.getElementById('enhanceBlessBtn').disabled = gameData.scrolls.blessed < 1;
        }

        function doEnhance(scrollType) {
            if (!selectedEnhanceItem) {
                alert('è«‹å…ˆé¸æ“‡è¦å¼·åŒ–çš„è£å‚™ï¼');
                return;
            }
            
            if (gameData.scrolls[scrollType] < 1) {
                alert('æ²è»¸ä¸è¶³ï¼');
                return;
            }
            
            const currentLevel = gameData.enhanceLevels[selectedEnhanceItem] || 0;
            if (currentLevel >= 10) {
                alert('å·²é”æœ€é«˜ç­‰ç´šï¼');
                return;
            }
            
            // æ¶ˆè€—æ²è»¸
            gameData.scrolls[scrollType]--;
            
            // è¨ˆç®—æˆåŠŸç‡
            let rate = enhanceRates[currentLevel + 1];
            if (scrollType === 'advanced') rate += 10;
            if (scrollType === 'blessed') rate += 15;
            rate = Math.min(100, rate);
            
            const success = Math.random() * 100 < rate;
            
            if (success) {
                gameData.enhanceLevels[selectedEnhanceItem] = currentLevel + 1;
                showPopup(`âœ¨ å¼·åŒ–æˆåŠŸï¼+${currentLevel + 1}`, 'success');
            } else {
                // å¤±æ•—è™•ç†
                if (currentLevel >= 6 && scrollType === 'basic') {
                    gameData.enhanceLevels[selectedEnhanceItem] = Math.max(0, currentLevel - 1);
                    showPopup(`ğŸ’” å¼·åŒ–å¤±æ•—ï¼Œé™ç´šè‡³ +${currentLevel - 1}`, 'fail');
                } else if (scrollType === 'blessed') {
                    showPopup('ğŸ’” å¼·åŒ–å¤±æ•—ï¼Œç­‰ç´šä¸è®Š', 'fail');
                } else {
                    showPopup('ğŸ’” å¼·åŒ–å¤±æ•—', 'fail');
                }
            }
            
            // æ›´æ–°é¡¯ç¤º
            const item = [...shopItems.weapon, ...shopItems.armor, ...shopItems.accessory].find(i => i.id === selectedEnhanceItem);
            selectEnhanceItem(item);
            renderScrollShop();
            saveUserData();
        }

        // ==================== UI æ›´æ–° ====================
        function updateDisplay() {
            document.getElementById('pointsDisplay').textContent = gameData.points;
            document.getElementById('streakDisplay').textContent = gameData.streak;
            document.getElementById('todayCount').textContent = gameData.todayTotal;
            
            const accuracy = gameData.totalQuestions > 0 
                ? Math.round(gameData.totalCorrect / gameData.totalQuestions * 100) 
                : 0;
            document.getElementById('accuracyDisplay').textContent = accuracy + '%';
            
            document.getElementById('charLevel').textContent = Math.floor(gameData.totalCorrect / 20) + 1;
        }

        function updateCharacter() {
            const preview = document.getElementById('characterPreview');
            preview.innerHTML = '';
            
            const layers = [
                { src: gameData.equipment.wings, z: 1, folder: '' },
                { src: gameData.equipment.armor, z: 2, folder: '' },
                { src: gameData.character.body, z: 3, folder: '' },
                { src: gameData.character.bottom, z: 4, folder: '' },
                { src: gameData.character.top, z: 5, folder: '' },
                { src: gameData.character.shoes, z: 6, folder: '' },
                { src: gameData.character.hair, z: 7, folder: '' },
                { src: gameData.character.eyes, z: 8, folder: '' },
                { src: gameData.character.eyebrow, z: 9, folder: '' },
                { src: gameData.character.eyelashes, z: 10, folder: '' },
                { src: gameData.character.mouth, z: 11, folder: '' },
                { src: gameData.equipment.accessory, z: 12, folder: '' },
                { src: gameData.equipment.weapon, z: 13, folder: '' },
            ].filter(l => l.src);
            
            layers.forEach(layer => {
                const img = document.createElement('img');
                // åˆ¤æ–·æ˜¯åŸºç¤ç´ æé‚„æ˜¯è£å‚™
                if (layer.src.startsWith('equipment/') || layer.src.startsWith('basics_')) {
                    img.src = 'assets/' + layer.src;
                } else {
                    // å¾ shopItems æ‰¾å°æ‡‰çš„åœ–ç‰‡è·¯å¾‘
                    const allItems = [...shopItems.weapon, ...shopItems.armor, ...shopItems.accessory, ...shopItems.wings];
                    const found = allItems.find(i => i.id === layer.src);
                    img.src = found ? 'assets/' + found.img : 'assets/' + layer.src;
                }
                img.style.zIndex = layer.z;
                preview.appendChild(img);
            });
        }

        function showPanel(panel) {
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.nav-btn.${panel}`).classList.add('active');
            
            document.getElementById('quizArea').classList.remove('active');
            document.getElementById('shopArea').classList.remove('active');
            document.getElementById('equipArea').classList.remove('active');
            
            document.getElementById(panel + 'Area').classList.add('active');
            
            if (panel === 'shop') renderShop();
            if (panel === 'equip') {
                renderEnhancePanel();
                updateEnhanceButtons();
            }
        }

        function showPopup(text, type) {
            const overlay = document.createElement('div');
            overlay.className = 'overlay';
            
            const popup = document.createElement('div');
            popup.className = 'popup ' + type;
            popup.textContent = text;
            
            document.body.appendChild(overlay);
            document.body.appendChild(popup);
            
            setTimeout(() => {
                overlay.remove();
                popup.remove();
            }, 1500);
        }

        // ==================== éµç›¤äº‹ä»¶ ====================
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && document.getElementById('quizArea').classList.contains('active')) {
                if (!document.getElementById('submitBtn').disabled) {
                    submitAnswer();
                }
            }
        });

        // ==================== åˆå§‹åŒ– ====================
        async function init() {
            // æª¢æŸ¥ç™»å…¥ç‹€æ…‹
            const hasSession = checkSession();
            
            // å…ˆè¼‰å…¥é¡Œåº«
            if (hasSession) {
                document.getElementById('questionText').innerHTML = 'ğŸ“š è¼‰å…¥é¡Œåº«ä¸­...';
            }
            await loadQuestionBank();
            
            if (hasSession) {
                loadQuestion();
                updateDisplay();
                updateCharacter();
                renderMissions();
                renderShop();
            }
        }
        
        // ç•¶ç™»å…¥/è¨»å†ŠæˆåŠŸå¾Œåˆå§‹åŒ–éŠæˆ²
        function initGame() {
            loadQuestion();
            updateDisplay();
            updateCharacter();
            renderMissions();
            renderShop();
        }

        init();
    </script>
</body>
</html>
